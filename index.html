<!--
Leaflet + Firebase Real-time Location Tracker
Single-file index.html

Instructions:
1) Replace the FIREBASE CONFIG PLACEHOLDER below with your Firebase config object.
   Example:
   const firebaseConfig = {
     apiKey: "...",
     authDomain: "...",
     databaseURL: "https://your-project.firebaseio.com",
     projectId: "...",
     storageBucket: "...",
     messagingSenderId: "...",
     appId: "..."
   };

2) Host this file on GitHub Pages or open locally (for local, some browsers block geolocation on file:// — use a simple HTTP server).
3) The left pane is the "User" view (shares your location). The right pane is the "Admin" view (shows all users from Realtime Database).
4) Make sure Realtime Database rules allow read/write for testing, or setup simple auth.

Path used in DB: /locations/<clientId>
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Location Tracker — Leaflet + Firebase</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2Gk9j8f2b0r8VYt3gZ2QmS2bF3yT9M2u5p3S0Xo=" crossorigin="" />
  <style>
    :root{--accent:#0ea5a4;--bg:#0f172a;--card:#0b1220;color-scheme:dark}
    html,body,#app{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    body{background:linear-gradient(180deg,#071129,#081428);color:#e6eef6}
    .header{display:flex;align-items:center;gap:12px;padding:12px 18px}
    .brand{font-weight:700;font-size:1.05rem}
    .container{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px;height:calc(100% - 64px)}
    .panel{background:rgba(255,255,255,0.02);border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);display:flex;flex-direction:column;overflow:hidden}
    .panel .top{padding:10px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.03)}
    .map{flex:1;min-height:0} /* for flexbox */
    .controls{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);border:none;padding:8px 10px;border-radius:8px;color:#062626;font-weight:600;cursor:pointer}
    .muted{opacity:0.8;font-size:0.9rem}
    .status{font-size:0.9rem}
    .small{font-size:0.85rem}
    .share-link{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 8px;border-radius:8px;color:inherit}
    .legend{padding:8px 12px;font-size:0.9rem}
    .footer{padding:8px 12px;border-top:1px solid rgba(255,255,255,0.02);font-size:0.85rem}
    @media(max-width:880px){.container{grid-template-columns:1fr;grid-auto-rows:1fr}}
  </style>
</head>
<body>
  <div id="app">
    <div class="header">
      <div class="brand">Location Tracker — Leaflet + Firebase</div>
      <div class="muted small">Free: Leaflet + OpenStreetMap • Realtime: Firebase Realtime DB</div>
    </div>

    <div class="container">
      <div class="panel" id="userPanel">
        <div class="top">
          <div>
            <strong>User View</strong>
            <div class="small muted">Share your live location (this device)</div>
          </div>
          <div class="controls">
            <button id="startShare">Start Sharing</button>
            <button id="stopShare" style="display:none">Stop</button>
          </div>
        </div>
        <div id="userMap" class="map"></div>
        <div class="legend">
          <div class="status" id="userStatus">Status: idle</div>
        </div>
        <div class="footer">Client ID: <span id="clientIdText" class="muted">(not connected)</span></div>
      </div>

      <div class="panel" id="adminPanel">
        <div class="top">
          <div>
            <strong>Admin View</strong>
            <div class="small muted">Shows all active users from Firebase</div>
          </div>
          <div class="controls">
            <button id="centerAll">Center All</button>
            <button id="clearAll">Clear DB</button>
          </div>
        </div>
        <div id="adminMap" class="map"></div>
        <div class="legend"><div class="small muted">Markers update in real-time as users share their location.</div></div>
        <div class="footer">DB path: <code class="muted">/locations/{clientId}</code></div>
      </div>
    </div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kGkQ0E2nL7vC2Xo3fT3mR9o3bGkY1FhJ6k0v0=" crossorigin=""></script>

  <!-- Firebase App + Database -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    /********************************************
     *  PASTE YOUR FIREBASE CONFIG OBJECT HERE  
     ********************************************/
    const firebaseConfig = {
      // <-- paste your firebase config here -->
      // apiKey: "...",
      // authDomain: "...",
      // databaseURL: "https://your-db.firebaseio.com",
      // projectId: "...",
      // storageBucket: "...",
      // messagingSenderId: "...",
      // appId: "..."
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Generate a short client id (you can replace with UUID if you prefer)
    const clientId = 'c_' + Math.random().toString(36).substring(2,9);
    document.getElementById('clientIdText').innerText = clientId;

    // --- USER MAP (left) ---
    const userMap = L.map('userMap', {zoomControl:true}).setView([20.5937,78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(userMap);

    let userMarker = null;
    let userAccuracyCircle = null;
    let watchId = null;

    function startSharing(){
      if(!('geolocation' in navigator)){
        updateUserStatus('Geolocation not supported by browser');
        return;
      }

      updateUserStatus('Requesting location...');
      // watchPosition for continuous updates
      watchId = navigator.geolocation.watchPosition(async (pos) =>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = pos.coords.accuracy;
        const ts = pos.timestamp;

        // Update marker on user map
        if(!userMarker){
          userMarker = L.marker([lat,lng]).addTo(userMap).bindPopup('You ('+clientId+')').openPopup();
          userAccuracyCircle = L.circle([lat,lng], {radius: acc}).addTo(userMap);
          userMap.setView([lat,lng], 15);
        } else {
          userMarker.setLatLng([lat,lng]);
          userAccuracyCircle.setLatLng([lat,lng]).setRadius(acc);
        }

        updateUserStatus(`Sharing — lat:${lat.toFixed(5)}, lng:${lng.toFixed(5)}, acc:${Math.round(acc)}m`);

        // Push to firebase: /locations/<clientId>
        try{
          await db.ref('locations/' + clientId).set({
            lat, lng, acc, ts, clientId
          });
        }catch(err){
          console.error('DB write error', err);
          updateUserStatus('DB write error: '+err.message);
        }
      }, (err)=>{
        console.error(err);
        updateUserStatus('Geolocation error: '+err.message);
      }, {enableHighAccuracy:true, maximumAge:0, timeout:10000});

      document.getElementById('startShare').style.display = 'none';
      document.getElementById('stopShare').style.display = 'inline-block';
    }

    function stopSharing(){
      if(watchId !== null) navigator.geolocation.clearWatch(watchId);
      watchId = null;
      updateUserStatus('Stopped');
      document.getElementById('startShare').style.display = 'inline-block';
      document.getElementById('stopShare').style.display = 'none';
      // Optionally remove from DB
      db.ref('locations/' + clientId).remove().catch(()=>{});
      if(userMarker) userMap.removeLayer(userMarker);
      if(userAccuracyCircle) userMap.removeLayer(userAccuracyCircle);
      userMarker = null; userAccuracyCircle = null;
    }

    function updateUserStatus(s){ document.getElementById('userStatus').innerText = 'Status: ' + s }

    document.getElementById('startShare').addEventListener('click', startSharing);
    document.getElementById('stopShare').addEventListener('click', stopSharing);

    // --- ADMIN MAP (right) ---
    const adminMap = L.map('adminMap', {zoomControl:true}).setView([20.5937,78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(adminMap);

    // Keep track of markers by clientId
    const markers = {};

    // Listen for changes under /locations
    const locRef = db.ref('locations');

    locRef.on('child_added', snapshot => {
      const data = snapshot.val();
      addOrUpdateMarker(data);
    });
    locRef.on('child_changed', snapshot => {
      const data = snapshot.val();
      addOrUpdateMarker(data);
    });
    locRef.on('child_removed', snapshot => {
      const id = snapshot.key;
      if(markers[id]){
        adminMap.removeLayer(markers[id].marker);
        adminMap.removeLayer(markers[id].circle);
        delete markers[id];
      }
    });

    function addOrUpdateMarker(data){
      const id = data.clientId || (data.clientId = 'id_' + Math.random().toString(36).slice(2,8));
      const lat = data.lat; const lng = data.lng; const acc = data.acc || 30;

      if(markers[id]){
        markers[id].marker.setLatLng([lat,lng]);
        markers[id].circle.setLatLng([lat,lng]).setRadius(acc);
      } else {
        const m = L.marker([lat,lng]).addTo(adminMap).bindPopup(`<strong>${id}</strong><br/>lat:${lat.toFixed(5)} lng:${lng.toFixed(5)}<br/>acc:${Math.round(acc)}m`);
        const c = L.circle([lat,lng], {radius: acc}).addTo(adminMap);
        markers[id] = {marker:m, circle:c};
      }
    }

    // Admin buttons
    document.getElementById('centerAll').addEventListener('click', ()=>{
      const keys = Object.keys(markers);
      if(!keys.length) return alert('No markers');
      const latlngs = keys.map(k=> markers[k].marker.getLatLng());
      const group = L.featureGroup(latlngs.map(ll=> L.marker([ll.lat,ll.lng])));
      adminMap.fitBounds(group.getBounds().pad(0.4));
    });

    document.getElementById('clearAll').addEventListener('click', ()=>{
      if(!confirm('Delete all locations from database?')) return;
      db.ref('locations').remove().catch(err=>alert('Error: '+err.message));
    });

    // Cleanup on unload — remove this client's DB entry if sharing
    window.addEventListener('beforeunload', ()=>{
      try{ db.ref('locations/' + clientId).remove(); }catch(e){}
    });

  </script>
</body>
</html>
